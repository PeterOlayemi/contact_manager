{% load static %}
{% load i18n %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{% block title %}Contact Manager{% endblock %}</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
    }
  </script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  
  <link rel="icon" href="{% static 'image/favicon.png' %}" type="image/png">
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
</head>
<body class="antialiased text-gray-800 bg-gray-100 dark:bg-gray-900 dark:text-gray-100">

  <!-- App container -->
  <div id="app" class="min-h-screen flex">

    {% if user.is_authenticated %}
    <!-- Mobile navbar -->
    <header class="w-full bg-white dark:bg-gray-900 
      border-b border-gray-200 dark:border-gray-700 flex items-center justify-between p-4 md:hidden">
      <div class="flex items-center gap-2">
        <button id="menuToggle" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800">
          <i data-feather="menu" class="w-6 h-6"></i>
        </button>
        <span class="font-semibold">Contact Manager</span>
      </div>
      <div class="flex items-center gap-3">
        <img src="https://api.dicebear.com/6.x/initials/svg?seed={{ user.username }}" class="w-8 h-8 rounded-full" alt="avatar">
      </div>
    </header>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 
      bg-white dark:bg-gray-900 
      border-r border-gray-200 dark:border-gray-700 
      transform -translate-x-full md:translate-x-0 
      transition-transform duration-200 ease-in-out">
      <div class="p-6">
        <!-- Logo -->
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold">CM</div>
          <div>
            <h1 class="text-lg font-semibold">Contact Manager</h1>
            <p class="text-xs text-gray-500 dark:text-gray-400">User dashboard</p>
          </div>
        </div>

        <!-- Nav -->
        <nav class="mt-8 space-y-2">
          <a href="{% url 'home' %}" class="side-link flex items-center gap-3 px-3 py-2 rounded-lg text-sm {% if request.resolver_match.url_name == 'home' %}bg-indigo-50 dark:bg-indigo-800/30 text-indigo-600 dark:text-indigo-200{% else %}hover:bg-gray-50 dark:hover:bg-gray-800{% endif %}">
            <i data-feather="home" class="w-4 h-4"></i> Dashboard
          </a>
          <form action="{% url 'import_contacts' %}" method="post" enctype="multipart/form-data" class="inline side-link flex items-center gap-3 px-3 py-2 rounded-lg text-sm {% if request.resolver_match.url_name == 'import_contacts' %}bg-indigo-50 dark:bg-indigo-800/30 text-indigo-600 dark:text-indigo-200{% else %}hover:bg-gray-50 dark:hover:bg-gray-800{% endif %}">
            {% csrf_token %}
            <input type="file" name="csv_file" accept=".csv" id="csvInputSidebar" class="hidden" onchange="this.form.submit()">
            <button type="button" id="importBtnSidebar" class="side-link flex items-center gap-3 rounded-lg text-sm">
              <i data-feather="upload" class="w-4 h-4"></i> Import
            </button>
          </form>
        </nav>

        <!-- Account -->
        <div class="mt-8">
          <h6 class="text-xs text-gray-500 dark:text-gray-400 uppercase">Account</h6>
          <div class="mt-3 flex items-center gap-3">
            <img src="https://api.dicebear.com/6.x/initials/svg?seed={{ user.username }}" alt="avatar" class="w-10 h-10 rounded-full" />
            <div>
              <div class="font-medium">{{ user.get_full_name|default:user.username }}</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">{{ user.email }}</div>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-4 md:p-6 md:ml-72">

      <!-- Top nav -->
      <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
          <button id="mobile-menu-btn" class="md:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-feather="menu" class="w-5 h-5"></i>
          </button>

          <div class="relative w-full max-w-xl">
          <input id="globalSearch" type="search" placeholder="Search contacts..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
          <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i data-feather="search" class="w-4 h-4"></i></div>
          </div>
      </div>

      <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
              <label class="flex items-center gap-2 cursor-pointer">
                  <input id="themeToggle" type="checkbox" class="hidden" />
                  <div id="themeSwitch" class="w-12 h-6 bg-gray-200 dark:bg-gray-600 rounded-full p-1 relative">
                      <div id="themeKnob" class="w-4 h-4 bg-white rounded-full shadow transform"></div>
                  </div>
                  <span class="text-sm text-gray-500 dark:text-gray-300 hide-mobile">Dark</span>
              </label>
          </div>

          <div class="relative">
          <button id="profileMenuBtn" class="flex items-center gap-2 px-3 py-1 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
              <img src="https://api.dicebear.com/6.x/initials/svg?seed={{ user.username }}" class="w-8 h-8 rounded-full" alt="user" />
              <div class="hidden sm:block text-left">
              <div class="text-sm font-medium">{{ user.username }}</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">Account</div>
              </div>
              <i data-feather="chevron-down" class="w-4 h-4"></i>
          </button>
          <div id="profileMenu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg overflow-hidden z-50">
              <a href="#" id="openProfile" class="block px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700">Profile</a>
              <a href="{% url 'account_logout' %}" class="block px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700">Sign out</a>
          </div>
          </div>
      </div>
      </header>

    {% else %}
    <main class="flex-1 p-4 md:p-6">
    {% endif %}
      {% if messages %}
      <div class="mt-6 space-y-3">
        {% for message in messages %}
        <div x-data="{ show: true }" 
            x-show="show" 
            x-transition 
            x-collapse 
            class="p-4 rounded-lg shadow
                    {% if message.tags == 'success' %} bg-green-100 text-green-800 border border-green-300
                    {% elif message.tags == 'error' %} bg-red-100 text-red-800 border border-red-300
                    {% elif message.tags == 'warning' %} bg-yellow-100 text-yellow-800 border border-yellow-300
                    {% else %} bg-blue-100 text-blue-800 border border-blue-300
                    {% endif %}">
          <div class="flex justify-between items-center">
            <span>{{ message }}</span>
            <button @click="show = false" class="ml-3 text-lg font-bold">x</button>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      {% block content %}
      {% endblock %}
    </main>
  </div>

  <!-- Toasts -->
  <div id="toastContainer" class="fixed right-6 bottom-6 z-50 space-y-2"></div>

  <!-- Scripts -->
  <script>feather.replace()</script>
  <script>
    const sidebar = document.getElementById("sidebar");
    const menuToggle = document.getElementById("menuToggle");
    if (menuToggle) {
      menuToggle.addEventListener("click", () => {
        sidebar.classList.toggle("-translate-x-full");
      });
    }
  </script>
  <script src="{% static 'js/base.js' %}"></script>
  <script src="{% static 'js/home.js' %}"></script>
  <script src="{% static 'js/event.js' %}"></script>
  <script src="{% static 'js/profile.js' %}"></script>
  <script src="{% static 'js/csv.js' %}"></script>
  <script src="{% static 'js/modal.js' %}"></script>
</body>
</html>
