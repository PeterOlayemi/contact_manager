{% extends 'base.html' %}

{% block title %}Home - Contact Manager{% endblock %}

{% block content %}

<!-- Page content -->
<div class="p-6">
<!-- Dashboard header / quick stats -->
<div id="dashboardView" class="space-y-6">
    <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
    <div>
        <h2 class="text-2xl font-bold">Contacts</h2>
        <p class="text-sm text-gray-500 dark:text-gray-400">Manage your contacts - data stored in our secure database.</p>
    </div>
    <div class="flex items-center gap-2">
        <button id="addContactBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:shadow-lg">+ Add Contact</button>
        <label class="cursor-pointer">
            <form action="{% url 'import_contacts' %}" method="post" enctype="multipart/form-data" class="inline">
                {% csrf_token %}
                <input type="file" name="csv_file" accept=".csv" id="csvInputHome" class="hidden" onchange="this.form.submit()">
                <button type="button" id="importBtnHome" class="px-4 py-2 border rounded-lg text-gray-700 dark:text-gray-200 
                                            bg-white dark:bg-gray-800 
                                            hover:bg-gray-50 dark:hover:bg-gray-700 
                                            transition-colors shadow-sm hover:shadow">Import CSV</button>
            </form>
        </label>
        <button id="exportBtn" class="px-4 py-2 border rounded-lg text-gray-700 dark:text-gray-200 
                                    bg-white dark:bg-gray-800 
                                    hover:bg-gray-50 dark:hover:bg-gray-700 
                                    transition-colors shadow-sm hover:shadow">Export CSV</button>
        <button id="printBtn" class="px-4 py-2 border rounded-lg text-gray-700 dark:text-gray-200 
                                    bg-white dark:bg-gray-800 
                                    hover:bg-gray-50 dark:hover:bg-gray-700 
                                    transition-colors shadow-sm hover:shadow">Print</button>
    </div>
    </div>

    <!-- Contacts card -->
    <div class="card">
        <!-- Controls -->
        <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3 mb-3">
            <div class="flex items-center gap-2">
                <!-- Per Page -->
                <select id="perPage" 
                    class="border border-gray-300 dark:border-gray-600 
                            rounded-md px-2 py-1 
                            bg-white dark:bg-gray-800 
                            text-gray-700 dark:text-gray-200 
                            focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <option value="5" {% if request.GET.perPage == "5" %}selected{% endif %}>5 / page</option>
                    <option value="10" {% if request.GET.perPage == "10" or not request.GET.perPage %}selected{% endif %}>10 / page</option>
                    <option value="20" {% if request.GET.perPage == "20" %}selected{% endif %}>20 / page</option>
                </select>

                <!-- Tag Filter -->
                <select id="tagFilter" 
                    class="border border-gray-300 dark:border-gray-600 
                            rounded-md px-2 py-1 
                            bg-white dark:bg-gray-800 
                            text-gray-700 dark:text-gray-200 
                            focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <option value="">All tags</option>
                    {% for tag in tags %}
                        <option value="{{ tag.name }}" {% if request.GET.tag == tag.name %}selected{% endif %}>{{ tag.name }}</option>
                    {% endfor %}
                </select>
                <a id="multiDeleteBtn" class="rounded-md px-2 py-1 text-red-700 bg-white dark:bg-gray-800 hover:bg-red-50 dark:hover:bg-red-900/30 transition-colors shadow-sm hover:shadow">Delete Selected</a>
                <a id="multiExportBtn" class="rounded-md px-2 py-1 text-gray-700 bg-white dark:text-gray-200 dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors shadow-sm hover:shadow">Export Selected</a>
            </div>

            <!-- Showing Count -->
            <div class="text-sm text-gray-500 dark:text-gray-400">
                Showing <span id="showingCount">0</span> contacts
            </div>
        </div>

        <!-- Contacts Table -->
        <div class="overflow-x-auto">
            <table class="w-full table-fixed-layout min-w-[800px]">
                <thead>
                    <tr class="text-left text-sm text-gray-600 dark:text-gray-300">
                    <th class="p-2"><input type="checkbox" id="selectAllContacts"></th>
                    <th class="p-2 cursor-pointer" data-sort="name">Name</th>
                    <th class="p-2 cursor-pointer" data-sort="email">Email</th>
                    <th class="p-2 cursor-pointer" data-sort="phone">Phone</th>
                    <th class="p-2">Tags</th>
                    <th class="p-2 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="contactsTableBody" class="text-sm"></tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="mt-4 flex items-center justify-between">
            <div class="text-sm text-gray-500 dark:text-gray-400">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></div>
            <div class="flex items-center gap-2">
                <button id="prevPage" class="px-3 py-1 border rounded disabled:opacity-50">Prev</button>
                <button id="nextPage" class="px-3 py-1 border rounded disabled:opacity-50">Next</button>
            </div>
        </div>
    </div>
</div>

</div>

<!-- Profile Modal -->
<div id="profileModal" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center z-50">
  <div class="w-full max-w-2xl mx-4 overflow-y-auto max-h-[90vh]">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">User Profile</h3>
        <button id="closeProfile" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-feather="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="space-y-4 text-sm">
        <div class="flex flex-col items-center gap-2">
          <img src="https://api.dicebear.com/6.x/initials/svg?seed={{ user.username }}"
               alt="avatar"
               class="w-16 h-16 rounded-full shadow" />
          <p class="font-medium text-lg">{{ user.get_full_name|default:user.username }}</p>
          <p class="text-gray-500 dark:text-gray-400">{{ user.email }}</p>
        </div>

        <div class="border-t border-gray-200 dark:border-gray-700 pt-4 space-y-2">
          <p><strong>Username:</strong> {{ user.username }}</p>
          <p><strong>Email:</strong> {{ user.email }}</p>
          <p><strong>First name:</strong> {{ user.first_name|default:"-" }}</p>
          <p><strong>Last name:</strong> {{ user.last_name|default:"-" }}</p>
          <p><strong>Joined:</strong> {{ user.date_joined|date:"F j, Y" }}</p>
          <p><strong>Last login:</strong> {{ user.last_login|date:"F j, Y, g:i a" }}</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add / Edit Modal -->
<div id="modalOverlay" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center z-50">
    <div class="w-full max-w-2xl mx-4 overflow-y-auto max-h-[90vh]">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 id="modalTitle" class="text-lg font-semibold">Add Contact</h3>
                <button id="closeModal" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700"><i data-feather="x" class="w-5 h-5"></i></button>
            </div>

            <form id="contactForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                <label class="text-sm">Name <span class="text-red-500">*</span></label>
                <input id="c_name" name="name" type="text" class="w-full border rounded px-3 py-2
                                                                bg-white dark:bg-gray-900 
                                                                text-gray-800 dark:text-gray-100 
                                                                border-gray-300 dark:border-gray-600
                                                                focus:outline-none focus:ring-2 focus:ring-indigo-400" required />
                <p class="text-xs text-red-500 mt-1 hidden" id="err_name">Name is required</p>
                </div>

                <div>
                <label class="text-sm">Email</label>
                <input id="c_email" name="email" type="email" class="w-full border rounded px-3 py-2
                                                                    bg-white dark:bg-gray-900 
                                                                    text-gray-800 dark:text-gray-100 
                                                                    border-gray-300 dark:border-gray-600
                                                                    focus:outline-none focus:ring-2 focus:ring-indigo-400" />
                <p class="text-xs text-red-500 mt-1 hidden" id="err_email">Enter a valid email</p>
                </div>

                <div>
                <label class="text-sm">Phone <span class="text-red-500">*</span></label>
                <input id="c_phone" name="phone_number" type="tel" class="w-full border rounded px-3 py-2
                                                                bg-white dark:bg-gray-900 
                                                                text-gray-800 dark:text-gray-100 
                                                                border-gray-300 dark:border-gray-600
                                                                focus:outline-none focus:ring-2 focus:ring-indigo-400" maxlength="14" required />
                <p class="text-xs text-red-500 mt-1 hidden" id="err_phone">Phone is required</p>
                </div>

                <div>
                <label class="text-sm">Tags (comma separated)</label>
                <input id="c_tags" name="tags" type="text" class="w-full border rounded px-3 py-2
                                                                bg-white dark:bg-gray-900 
                                                                text-gray-800 dark:text-gray-100 
                                                                border-gray-300 dark:border-gray-600
                                                                focus:outline-none focus:ring-2 focus:ring-indigo-400" />
                </div>

                <div class="md:col-span-2">
                <label class="text-sm">Address</label>
                <input id="c_address" name="address" type="text" class="w-full border rounded px-3 py-2
                                                                    bg-white dark:bg-gray-900 
                                                                    text-gray-800 dark:text-gray-100 
                                                                    border-gray-300 dark:border-gray-600
                                                                    focus:outline-none focus:ring-2 focus:ring-indigo-400" />
                </div>

                <div class="md:col-span-2">
                <label class="text-sm">Notes</label>
                <textarea id="c_notes" name="note" rows="3" class="w-full border rounded px-3 py-2
                                                                bg-white dark:bg-gray-900 
                                                                text-gray-800 dark:text-gray-100 
                                                                border-gray-300 dark:border-gray-600
                                                                focus:outline-none focus:ring-2 focus:ring-indigo-400"></textarea>
                </div>

                <div>
                <label class="text-sm">Profile Picture</label>
                <input id="c_avatar" name="image" type="file" accept="image/*" class="w-full" />
                <div id="avatarPreview" class="mt-2"></div>
                </div>

                <div class="flex items-center gap-2 md:justify-end">
                <button type="button" id="cancelForm" class="px-4 py-2 border rounded">Cancel</button>
                <button type="submit" id="saveContact" class="px-4 py-2 bg-indigo-600 text-white rounded">Save</button>
                </div>

                <!-- hidden id -->
                <input type="hidden" id="editingId" />
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center z-50">
  <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-xl w-full max-w-sm">
    <h3 id="deleteModalTitle" class="text-lg font-semibold mb-4">Delete Contact?</h3>
    <p id="deleteModalMessage" class="mb-6 text-sm text-gray-500">
      Are you sure you want to delete this contact?
    </p>
    <div class="flex justify-end gap-3">
      <button onclick="closeDeleteModal()" class="px-4 py-2 border rounded">Cancel</button>
      <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded">Delete</button>
    </div>
  </div>
</div>

<!-- View Details Modal -->
<div id="detailOverlay" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center z-40">
<div class="w-full max-w-2xl mx-4 overflow-y-auto max-h-[90vh]">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Contact Details</h3>
        <button class="closeDetail p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700"><i data-feather="x" class="w-5 h-5"></i></button>
    </div>

    <div id="detailCard" class="text-center space-y-4">
        <!-- content injected -->
    </div>
    </div>
</div>
</div>

{{ contacts_json|json_script:"contacts-data" }}
<script>
    const contacts = JSON.parse(document.getElementById("contacts-data").textContent);
</script>

{% endblock %}
